- RAG는 텍스트를 벡터화해 검색기능을 가능하게 한다.
- 벡터화란 단순 데이터를 숫자 배열(벡터)로 변환하는 과정입니다. (원-핫 인코딩같은 단순 변환도 벡터화에 포함)
- 임베딩이란 벡터화의 특별한 형태로 데이터의 의미와 관계를 보존하면서 벡터로 변환하는 것을 뜻함
  (단순 변환이 아닌 "의미 있는 벡터 공간"으로 맵핑 -> 비슷한 의미를 가진 데이터는 벡터 공간에서도 가까이 위치한다.)
  (벡터 공간은 수십차원이 될 수 도있다. OpenAI의 text-embedding-ada-002 임베딩 모델은 1536차원의 벡터 공간을 사용한다.)
- text-embedding-ada-002은 코사인 유사도를 사용해 계산하는 것을 권장한다.

# 벡터 유사도 검색에서 RAG를 통합하는 구체적인 절차

- 1단계: 사전준비
- 2단계: 검색 및 프롬프트 구축

## 1단계: 사전준비

- 정보의 출처가 되는 문서 정보를 DB에 넣어 질문으로 검색할 수 있게 하는것
- pdf던 뭐던 전부 텍스트화하여 벡터화하여 DB에 저장해야한다.

1. 텍스트 추출 (ex. pdf)
2. 텍스트 분할 (문장 구조가 안깨지는도록)
3. 텍스트의 벡터화
4. 텍스트와 벡터를 백터 DB에 저장

- 텍스트 분할 시 문장 구조가 무너지지않게 하기 위해 적절한 위치에서 분할할 수있는 기능을 제공하는 것이 바로 "Text splitters"이며 분할 방식에 따라 다양한 종류가 있다.
- 여기서는 spaCy를 사용한다.(자연어 처리 라이브러리)
- spaCy에서 언어 처리를 하기 위해서는 대상 언어의 "모델"이라는 데이터를 다운로드해야한다. python -m spacy download ko_core_news_sm
- 참고로 문서 청킹 크기와 방식이 성능에 큰 영향을 미친다.
- 임베딩 모델의 선택도 중요하다.
- 최근에는 재순위화(reranking)나 다중 쿼리 확장 등의 고급 기법들도 사용된다.

## 2단계: 검색 및 프롬프트 구축

- 사용자 처리를 받아들였을 때 하는 단계로 "사전 준비된 DB"에서 질문과 유사한 벡터를 검색하여 정보원이 될 문장을 여러개 획득한다.
- 그다음 획득한 문장과 질문을 조합해 프롬프트를 구성한다.

1. 사용자의 입력을 벡터화
2. 사용자 입력의 벡터를 미리 준비된 DB에서 검색해 문장 가져오기
3. 획득한 유사 문장과 질문을 조합해 프롬프트 작성 (PromptTemplate을 사용)
4. 생성한 프롬프트를 사용해 언어모델 호출

## chainlit 사용

- 실행 명령어: chainlit run <파일명>.py

## RetrivalQA로 RAG 개발 코드를 간단하게

- RetrivalQA는 LangChain이 제고하는 질의응답 시스템으로 다른 문서를 검색하고, 해당 문서에 대한 질문에 대답할 수 있도록 설계되었다.
- Retrievers는 특정 단어로 검색을 하면 관련된 여러 문서(문장)을 얻을 수 있는 일련의 기능을 총칭한다. (pdf, wikipedia)
- RetrivalQA를 사용하는데 있어 Retriever가 반드시 필요하다. (db로부터 얻음 > database.as_retriever())
- RetrivalQA를 사용하면 정보원 텍스트 구축(DB로부터 조회해서 텍스트 합치기), PropmptTemplate 작성등을 하지않아도 된다.
- RetrivalQA의 또 다른 장점은 정보 출처가 되는 문장을 생성하는 방법을 선택할 수 있다.
  우리가 구현한 예시는 텍스트 결합시 생성되는 문자열이 굉장히 작기때문에 PromptTemplate을 이용해서 최종적으로 질문 내용을 만들 수 있지만
  정보 출처로서 여러 긴 문장이 필요한 질문에는 대응할 수 없다.
  이러한 문제에 대응하기 위해 랭체인은 Refine, Map reduce, Map re-rank같은 결합 방법을 제공한다.
- Retrieval 모듈은 준비된 Retrievers를 사용해 위키백과를 정보원으로 활용할 수 있다.

## RePhraseQueryRetriever

- RePhraseQueryRetriever는 질문을 재구성하기 위한 Retriever로 llm_chain과 retriever를 인자로 받음
- RePhraseQueryRetriever는 먼저 질문을 재구성하고, 그 결과를 WikipediaRetriever에 전달해 검색을 수행한다.
